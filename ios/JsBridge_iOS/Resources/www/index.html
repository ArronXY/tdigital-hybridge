<!DOCTYPE html>
<html>
<head>
    <title>Test</title>
    <script type="text/javascript" src="jquery.min.js"></script>
    <style type="text/css">
        * {
          box-sizing: border-box;
        }
        body {
            background: #222;
            font-family: "HelveticaNeue", Helvetica, sans-serif;
            font-size: 15px;
            text-align: center;
        }

        #botonaco {
            text-decoration: none;
            padding: 8px;
            color: white;
            margin: 8px;
            display: inline-block;
            background: gray;
            -webkit-border-radius: 8px;
            font-family: Helvetica, sans-serif;
        }

        #logger {
          background-color: #AAA;
          border: 1px dashed white;
          width: 100%;
          height: 430px;
          overflow: scroll;
          padding: 5% 1%;
        }
        #logger > div {
          border-bottom: 1px solid gray;
          text-align: left;
          font-size: 60%;
        }

    </style>


    <script type="text/javascript">
        var uniqueId = 0;
        var action = 'state';
        var id = 666;
        var JSONData = {
            timestamp: new Date().getTime()
        }

        JsBridge = {};
        JsBridge.events = [];
        
        // Crear eventos bridge
        JsBridge.events['JsBridgeReady'] = new Event('JsBridgeReady');
        JsBridge.events['JsBridgeMessage'] = new Event('JsBridgeMessage');
        
        JsBridge.dispatchEvent = function(type, data) {
            JsBridge.events[type].data = data;
            document.dispatchEvent(JsBridge.events[type]);
        }
        
        var getNativeData = function(params) {
          var url = 'hybridge://' + action +'/' + id + '/' + new Date().getTime();
          var xhr = $.ajax({
            url: url,
            type: 'HEAD',
            beforeSend: function (xhr) {
              xhr.setRequestHeader('id', ++uniqueId);
              xhr.setRequestHeader('data', JSON.stringify(params));
            },
            error: function () { console.error('error', arguments) },
            success: function (data) {
              var time = new Date(data.timestamp);
              console.log("Son las " + time.getHours() + " y " + time.getMinutes(), data);
            }
          });
          return xhr;
        };

        $(document).ready(function () {
            var logger = console.log;
            console.log = function () {
                $('#logger').append('<div>' + (typeof arguments[0] == 'object'? JSON.stringify(arguments[0]) : arguments[0]) + '</div>');
                logger.apply(console, arguments);
            };      
                   
            $("#botonaco").click(function () {
              var params = {"timestamp": new Date().getTime()};
              $.when(getNativeData(params))
                .done(function(data) {
                  console.log(data);
                  var time = new Date(data.timestamp);
                  console.log("Son las " + time.getHours() + " y " + time.getMinutes());
                })
                .fail(function () { console.error('error', arguments) });
                return false;
            });

            /*document.addEventListener("JsBridgeReady", function (ev) {
              alert("JsBridge cargado");
              console.log("JsBridge cargado", ev);
            }, false);*/
                          
            document.addEventListener("JsBridgeMessage", function (ev) {
              console.log("Evento JsBridge dice... primer callback", ev.data.timestamp);
            }, false);
                          
            document.addEventListener("JsBridgeMessage", function (ev) {
              console.log("Evento JsBridge dice... segundo callback", ev.data.timestamp);
            }, false);
        });

    </script>
</head>

<body>

<a id="botonaco" href="#">Native Bridge</a>
<div id="logger"></div>
</body>
</html>